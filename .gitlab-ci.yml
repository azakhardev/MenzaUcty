stages:
  - test_backend
  - build_backend
  - build_frontend

# ====================================================================
# SDOÍLENÉ NASTAVENÍ (Global Cache)
# ====================================================================
# Aby se Maven závislosti nestahovaly dvakrát (jednou pro test, jednou pro build),
# definujeme cache globálně nebo použijeme stejný klíč.
cache:
  key: "$CI_COMMIT_REF_SLUG-backend"
  paths:
    - backend/menza-api/.m2/repository

# ====================================================================
# BACKEND TEST JOB (NOVÝ)
# Spustí Unit testy. Pokud selžou, pipeline se zastaví.
# ====================================================================
test_backend_job:
  stage: test_backend
  image: maven:3.8-openjdk-17

  script:
    - echo "Spouštím testy Backend API..."
    - cd backend/menza-api
    - chmod +x ./mvnw
    - mkdir -p .m2/repository
    # Zde spouštíme POUZE testy.
    # '-Dmaven.repo.local=.m2/repository' říká Mavenu, aby použil naši cache složku
    - ./mvnw test -Dmaven.repo.local=.m2/repository
    - echo "Testy dokončeny úspěšně."

  # Toto zajistí, že GitLab uvidí výsledky testů (počet prošlých/chybných) v hezkém grafu
  artifacts:
    when: always
    reports:
      junit:
        - backend/menza-api/target/surefire-reports/TEST-*.xml

# ====================================================================
# BACKEND BUILD JOB
# Sestavení Spring Boot REST API
# ====================================================================

build_backend_job:
  stage: build_backend
  # Job se spustí jen pokud projde předchozí stage 'test'
  needs: ["test_backend_job"]
  image: maven:3.8-openjdk-17

  script:
    - echo "Spouštím sestavení Backend API..."
    - cd backend/menza-api
    - chmod +x ./mvnw
    - mkdir -p .m2/repository
    # Zde necháváme -DskipTests, protože testy už proběhly v předchozím kroku!
    # Ušetříme tím čas.
    - ./mvnw package -DskipTests -Dmaven.repo.local=.m2/repository
    - echo "Sestavení Backend API dokončeno."

  artifacts:
    paths:
      - backend/menza-api/target/*.jar
    expire_in: 1 week

# ====================================================================
# FRONTEND BUILD JOB
# Sestavení React aplikace
# ====================================================================

build_frontend_job:
  stage: build_frontend
  image: node:18.19.1

  # Frontend má vlastní cache (node_modules), takže přepíšeme tu globální
  cache:
    key: "$CI_COMMIT_REF_SLUG-frontend"
    paths:
      - frontend/menza-web/node_modules/

  script:
    - echo "Spouštím sestavení Frontend React aplikace..."
    - cd frontend/menza-web
    - npm install
    - npm run build
    - echo "Sestavení Frontend aplikace dokončeno."

  artifacts:
    paths:
      - frontend/menza-web/dist/
    expire_in: 1 week